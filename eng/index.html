<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heat Pump Heating Curve Calculator (Midea M-Thermal Arctic 8 kW)</title>
  <a href="https://una-newbury.github.io/midea/eng/" target="_blank" rel="noopener noreferrer" ><small><small>self-link</small></small></a>
  <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
    }

    .container {
        background: white;
        border-radius: 8px;
        padding: 25px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    h1 {
        color: #2c3e50;
        margin-top: 0;
    }

    .controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .control-group {
        display: flex;
        flex-direction: column;
    }

    label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #34495e;
    }

    select, input[type="number"] {
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 4px;
        font-size: 16px;
        transition: border-color 0.3s;
    }

    select:focus, input[type="number"]:focus {
        outline: none;
        border-color: #3498db;
    }

    .value-display {
        font-size: 14px;
        color: #7f8c8d;
        margin-top: 4px;
    }

    #chart {
        width: 100%;
        height: 400px;
        margin: 20px 0;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    th, td {
        padding: 12px;
        text-align: center;
        border: 1px solid #e0e0e0;
    }

    th {
        background-color: #3498db;
        color: white;
        font-weight: 600;
    }

    tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    tr:hover {
        background-color: #e8f4f8;
    }

    .capped {
        color: #e74c3c;
        font-weight: 600;
    }

    .info-box {
        background-color: #e8f4f8;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }

    .info-box h3 {
        margin-top: 0;
        color: #2980b9;
    }

    canvas {
        border: 1px solid #e0e0e0;
        border-radius: 4px;
    }

    .formula-box {
        background-color: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 4px;
        margin: 20px 0;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        line-height: 1.8;
        white-space: pre-wrap;
        word-wrap: break-word;
        position: relative;
    }

    .formula-box h3 {
        color: #3498db;
        margin-top: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .copy-button {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 8px 16px;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .copy-button:hover {
        background-color: #2980b9;
    }

    .copy-button:active {
        background-color: #1c6ea4;
    }

    .copied {
        background-color: #27ae60 !important;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üå°Ô∏è Heat Pump Heating Curve Calculator (Midea M-Thermal Arctic 8 kW)</h1>

  <div class="info-box">
    <h3>About</h3>
    <p>This calculator shows the supply water temperature (T1S) based on outdoor temperature (T4) for different heating curves. Higher curve numbers provide more aggressive heating for poorly insulated buildings.</p>
  </div>

  <div class="controls">
    <div class="control-group">
      <label for="curve">Heating Curve:</label>
      <select id="curve">
        <option value="1">1-T1S (Gentle - well insulated)</option>
        <option value="2">2-T1S</option>
        <option value="3" selected>3-T1S</option>
        <option value="4">4-T1S (Typical)</option>
        <option value="5">5-T1S</option>
        <option value="6">6-T1S</option>
        <option value="7">7-T1S</option>
        <option value="8">8-T1S (Aggressive - poor insulation)</option>
      </select>
    </div>

    <div class="control-group">
      <label for="offset">Offset (¬∞C):</label>
      <input type="number" id="offset" value="12" min="-20" max="20" step="1">
      <span class="value-display">Current: <span id="offsetValue">12</span>¬∞C</span>
    </div>

    <div class="control-group">
      <label for="maxTemp">Maximum Temperature Limit (¬∞C):</label>
      <input type="number" id="maxTemp" value="60" min="40" max="80" step="1">
      <span class="value-display">Current: <span id="maxTempValue">60</span>¬∞C</span>
    </div>
  </div>
</div>

<div class="container">
  <h2>üìä Visual Curve</h2>
  <canvas id="chart"></canvas>
</div>

<div class="container">
  <h2>üìã Temperature Table</h2>
  <table id="dataTable">
    <thead>
    <tr>
      <th>Outdoor Temp (T4)</th>
      <th>Set Temp (T1S)</th>
      <th>Status</th>
    </tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
  </table>
</div>

<div class="container">
  <div class="formula-box">
    <button class="copy-button" onclick="copyFormula()">üìã Copy Formula</button>
    <h3>Current Formula</h3>
    <div id="formulaDisplay"></div>
  </div>
</div>

<script>
  // Curve parameters
  const curves = {
      1: { a: 0.175, b: 25, c: 0.25 },
      2: { a: 0.35, b: 30, c: 0.5 },
      3: { a: 0.525, b: 35, c: 0.75 },
      4: { a: 0.63, b: 38, c: 0.9 },
      5: { a: 0.875, b: 45, c: 1.25 },
      6: { a: 0.98, b: 48, c: 1.4 },
      7: { a: 1.225, b: 55, c: 1.75 },
      8: { a: 1.4, b: 60, c: 2.0 }
  };

  // Calculate temperature for given outdoor temp
  function calculateTemp(T4, curveNum, offset, maxTemp) {
      const curve = curves[curveNum];
      let T1S;

      if (T4 < 0) {
          T1S = curve.a * (0 - T4) + curve.b;
      } else if (T4 >= 0 && T4 < 20) {
          T1S = curve.c * (20 - T4) + 20;
      } else {
          T1S = 20;
      }

      T1S += offset;

      const capped = T1S > maxTemp;
      if (capped) {
          T1S = maxTemp;
      }

      return { temp: T1S, capped: capped };
  }

  // Generate formula text
  function getFormulaText() {
      const curveNum = parseInt(document.getElementById('curve').value);
      const offset = parseFloat(document.getElementById('offset').value);
      const maxTemp = parseFloat(document.getElementById('maxTemp').value);
      const curve = curves[curveNum];

      const offsetStr = offset >= 0 ? `+ ${offset}` : `- ${Math.abs(offset)}`;

      let formula = `Heating Curve ${curveNum}-T1S Formula:

if (T4 < 0):
T1S = ${curve.a} √ó (0 - T4) + ${curve.b} + Offset

else if (T4 >= 0 and T4 < 20):
T1S = ${curve.c} √ó (20 - T4) + 20 + Offset

else if (T4 >= 20):
T1S = 20 + Offset

Where:
T4 = Outdoor temperature (¬∞C)
T1S = Supply water temperature (¬∞C)
Offset = ${offset}¬∞C

Finally, cap the result:
if T1S > ${maxTemp}: T1S = ${maxTemp}

Current settings result in:
- When T4 = -20¬∞C: T1S = ${calculateTemp(-20, curveNum, offset, maxTemp).temp.toFixed(1)}¬∞C
- When T4 = 0¬∞C: T1S = ${calculateTemp(0, curveNum, offset, maxTemp).temp.toFixed(1)}¬∞C
- When T4 = 10¬∞C: T1S = ${calculateTemp(10, curveNum, offset, maxTemp).temp.toFixed(1)}¬∞C
- When T4 = 20¬∞C: T1S = ${calculateTemp(20, curveNum, offset, maxTemp).temp.toFixed(1)}¬∞C`;

      return formula;
  }

  // Update formula display
  function updateFormula() {
      document.getElementById('formulaDisplay').textContent = getFormulaText();
  }

  // Copy formula to clipboard
  function copyFormula() {
      const formulaText = getFormulaText();
      navigator.clipboard.writeText(formulaText).then(() => {
          const button = document.querySelector('.copy-button');
          const originalText = button.textContent;
          button.textContent = '‚úì Copied!';
          button.classList.add('copied');

          setTimeout(() => {
              button.textContent = originalText;
              button.classList.remove('copied');
          }, 2000);
      }).catch(err => {
          alert('Failed to copy formula to clipboard');
          console.error('Copy failed:', err);
      });
  }

  // Draw chart
  function drawChart() {
      const canvas = document.getElementById('chart');
      const ctx = canvas.getContext('2d');
      const curve = parseInt(document.getElementById('curve').value);
      const offset = parseFloat(document.getElementById('offset').value);
      const maxTemp = parseFloat(document.getElementById('maxTemp').value);

      // Set canvas size
      canvas.width = canvas.offsetWidth;
      canvas.height = 400;

      const width = canvas.width;
      const height = canvas.height;
      const padding = 60;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Calculate chart dimensions
      const chartWidth = width - 2 * padding;
      const chartHeight = height - 2 * padding;

      // Temperature range
      const minT4 = -30;
      const maxT4 = 30;
      const minT1S = 0;
      const maxT1S = Math.max(80, maxTemp + 10);

      // Draw axes
      ctx.strokeStyle = '#2c3e50';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, height - padding);
      ctx.lineTo(width - padding, height - padding);
      ctx.stroke();

      // Draw grid
      ctx.strokeStyle = '#ecf0f1';
      ctx.lineWidth = 1;

      // Horizontal grid lines
      for (let i = 0; i <= 8; i++) {
          const y = padding + (chartHeight / 8) * i;
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(width - padding, y);
          ctx.stroke();
      }

      // Vertical grid lines
      for (let i = 0; i <= 12; i++) {
          const x = padding + (chartWidth / 12) * i;
          ctx.beginPath();
          ctx.moveTo(x, padding);
          ctx.lineTo(x, height - padding);
          ctx.stroke();
      }

      // Draw max temp limit line
      const maxTempY = padding + chartHeight - ((maxTemp - minT1S) / (maxT1S - minT1S)) * chartHeight;
      ctx.strokeStyle = '#e74c3c';
      ctx.lineWidth = 2;
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(padding, maxTempY);
      ctx.lineTo(width - padding, maxTempY);
      ctx.stroke();
      ctx.setLineDash([]);

      // Draw curve
      ctx.strokeStyle = '#3498db';
      ctx.lineWidth = 3;
      ctx.beginPath();

      for (let T4 = minT4; T4 <= maxT4; T4 += 0.5) {
          const result = calculateTemp(T4, curve, offset, maxTemp);
          const x = padding + ((T4 - minT4) / (maxT4 - minT4)) * chartWidth;
          const y = padding + chartHeight - ((result.temp - minT1S) / (maxT1S - minT1S)) * chartHeight;

          if (T4 === minT4) {
              ctx.moveTo(x, y);
          } else {
              ctx.lineTo(x, y);
          }
      }
      ctx.stroke();

      // Labels
      ctx.fillStyle = '#2c3e50';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';

      // X-axis labels
      for (let T4 = minT4; T4 <= maxT4; T4 += 10) {
          const x = padding + ((T4 - minT4) / (maxT4 - minT4)) * chartWidth;
          ctx.fillText(T4 + '¬∞C', x, height - padding + 25);
      }

      // Y-axis labels
      ctx.textAlign = 'right';
      for (let T1S = 0; T1S <= maxT1S; T1S += 10) {
          const y = padding + chartHeight - ((T1S - minT1S) / (maxT1S - minT1S)) * chartHeight;
          ctx.fillText(T1S + '¬∞C', padding - 10, y + 5);
      }

      // Axis titles
      ctx.font = 'bold 16px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Outdoor Temperature (T4)', width / 2, height - 5);

      ctx.save();
      ctx.translate(15, height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText('Supply Water Temperature (T1S)', 0, 0);
      ctx.restore();

      // Legend
      ctx.font = '12px Arial';
      ctx.textAlign = 'left';
      ctx.fillStyle = '#e74c3c';
      ctx.fillText('‚îÄ‚îÄ Max Temp Limit (' + maxTemp + '¬∞C)', width - padding - 180, 30);
      ctx.fillStyle = '#3498db';
      ctx.fillText('‚îÄ‚îÄ Heating Curve ' + curve, width - padding - 180, 50);
  }

  // Update table
  function updateTable() {
      const curve = parseInt(document.getElementById('curve').value);
      const offset = parseFloat(document.getElementById('offset').value);
      const maxTemp = parseFloat(document.getElementById('maxTemp').value);
      const tbody = document.getElementById('tableBody');

      tbody.innerHTML = '';

      for (let T4 = -30; T4 <= 30; T4 += 1) {
          const result = calculateTemp(T4, curve, offset, maxTemp);
          const row = tbody.insertRow();

          const cell1 = row.insertCell(0);
          const cell2 = row.insertCell(1);
          const cell3 = row.insertCell(2);

          cell1.textContent = T4 + '¬∞C';
          cell2.textContent = result.temp.toFixed(1) + '¬∞C';

          if (result.capped) {
              cell2.classList.add('capped');
              cell3.textContent = '‚ö†Ô∏è Capped at limit';
              cell3.classList.add('capped');
          } else {
              cell3.textContent = '‚úì Normal';
          }
      }
  }

  // Update everything
  function update() {
      document.getElementById('offsetValue').textContent = document.getElementById('offset').value;
      document.getElementById('maxTempValue').textContent = document.getElementById('maxTemp').value;
      updateFormula();
      drawChart();
      updateTable();
  }

  // Event listeners
  document.getElementById('curve').addEventListener('change', update);
  document.getElementById('offset').addEventListener('input', update);
  document.getElementById('maxTemp').addEventListener('input', update);

  // Initial update
  window.addEventListener('load', update);
  window.addEventListener('resize', drawChart);
</script>
</body>
</html>